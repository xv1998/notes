网络劫持类型：

劫持用户端、劫持服务端返回的数据





## HTTPS 劫持

前提：信任了不安全的 `CA` 证书【[CA 证书](./CA证书.md)】

> 原因：不安全的 CA 证书可以给任何网站进行签名，TLS 服务端解密需要服务端的私钥和证书，而 CA 可以提供用户展示信任服务端的私钥和证书。

以下阐述怎么去劫持：

#### 代理劫持

![代理劫持](https://blog.xray.cool/post-images/1609836822374.png)

前提：可以通过  `fiddler` 等工具代理转发请求到中间人。

步骤：

1. 代理服务器和客户端进行 `HTTP` 连接
2. 代理服务器返回 `200` ，连接成功
3. 客户端进行 `TLS` 连接，中间人通过 `SNI` 知道目标服务器
4. 中间人连接目标服务器
5. 中间人根据  `SNI` 和 `CA` （不安全的）自动签发假的服务端证书，并返回给用户进行握手
6. 握手成功，客户端发送请求
7. 中间人实现流量转发



#### 透明劫持（传输层劫持）

原理：直接由路由器把流量设置到中间人上进行劫持。

步骤：

1. 客户端连接服务器
2. 路由器（比如通过防火墙）重定向客户端连接到中间人
3. 中间人通过 `SNI` 知道链接具体哪个目标网站
4. 替换证书劫持



### 如何防止劫持

#### 服务端证书锁定： SSL/TLS pinning

一般针对移动端防劫持，原理在把服务端证书内置在客户端里，在客户端访问服务端时，因为`SSL/TLS pining` 强制验证服务端返回的证书中是否包含目标证书，所以可以知道服务端证书是否被调包。

**缺点**：如果客户端过期，证书或公钥被吊销，需要用户强制更新客户端



#### 什么是SNI

一个 `HTTPS` 服务器可能有多个域名，当进行 `TLS  `握手时，不同网站对应的 `TLS` 服务配置不一样，如果握手不带上域名，服务器或中间件就不知道要转发到哪个站点上，所以需要设置 `Server Name` 为网站的域名。

> 为什么不用 HTTP Host 字段？不是也有域名信息么？
>
> 因为 TLS 是 HTTP 的前置条件，域名拿不到，没办法进行 TLS 签名。



### 加密又加密

除了获取服务端的公钥对传输内容加密，还可以对传输内容先进行一层加密，中间人即使有服务端私钥，获取到内容也没意义了。